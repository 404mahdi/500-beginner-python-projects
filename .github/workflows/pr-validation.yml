name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install security tools
        run: |
          pip install bandit safety --quiet
          
      - name: Security scan for malicious code
        id: security-scan
        run: |
          echo "üîí Running security checks for malicious code patterns..."
          SECURITY_PASSED=true
          SECURITY_WARNINGS=""
          
          # Get list of changed Python files
          CHANGED_PY_FILES=$(git diff --name-only --diff-filter=AM origin/main | grep '\.py$' || true)
          
          if [ -z "$CHANGED_PY_FILES" ]; then
            echo "No Python files changed, skipping security scan"
            echo "security_result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üìù Scanning files: $CHANGED_PY_FILES"
          
          # Check for dangerous patterns in Python code
          for PY_FILE in $CHANGED_PY_FILES; do
            if [ ! -f "$PY_FILE" ]; then
              continue
            fi
            
            echo ""
            echo "Scanning: $PY_FILE"
            
            # Check for eval/exec usage (using -E for extended regex)
            if grep -nE "eval[[:space:]]*\(" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found eval() in $PY_FILE - this can execute arbitrary code"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`eval()\` in $PY_FILE (line $(grep -nE 'eval[[:space:]]*\(' "$PY_FILE" | cut -d: -f1 | head -1)) - can execute arbitrary code"
              SECURITY_PASSED=false
            fi
            
            if grep -nE "exec[[:space:]]*\(" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found exec() in $PY_FILE - this can execute arbitrary code"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`exec()\` in $PY_FILE (line $(grep -nE 'exec[[:space:]]*\(' "$PY_FILE" | cut -d: -f1 | head -1)) - can execute arbitrary code"
              SECURITY_PASSED=false
            fi
            
            # Check for compile() usage
            if grep -nE "compile[[:space:]]*\(" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found compile() in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`compile()\` in $PY_FILE (line $(grep -nE 'compile[[:space:]]*\(' "$PY_FILE" | cut -d: -f1 | head -1)) - can compile and execute code"
              SECURITY_PASSED=false
            fi
            
            # Check for __import__ usage
            if grep -nE "__import__[[:space:]]*\(" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found __import__() in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`__import__()\` in $PY_FILE (line $(grep -nE '__import__[[:space:]]*\(' "$PY_FILE" | cut -d: -f1 | head -1)) - can dynamically import modules"
              SECURITY_PASSED=false
            fi
            
            # Check for os.system usage
            if grep -nE "os\.system[[:space:]]*\(" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found os.system() in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`os.system()\` in $PY_FILE (line $(grep -nE 'os\.system[[:space:]]*\(' "$PY_FILE" | cut -d: -f1 | head -1)) - can execute shell commands"
              SECURITY_PASSED=false
            fi
            
            # Check for subprocess with shell=True
            if grep -nE "shell[[:space:]]*=[[:space:]]*True" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found shell=True in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`shell=True\` in subprocess call in $PY_FILE (line $(grep -nE 'shell[[:space:]]*=[[:space:]]*True' "$PY_FILE" | cut -d: -f1 | head -1)) - can lead to shell injection"
              SECURITY_PASSED=false
            fi
            
            # Check for pickle usage (can execute arbitrary code)
            if grep -n "import pickle\|from pickle" "$PY_FILE" 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found pickle import in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found \`pickle\` import in $PY_FILE - pickle can execute arbitrary code during deserialization"
              SECURITY_PASSED=false
            fi
            
            # Check for requests to suspicious domains or IPs
            if grep -niE "(http://|https://)?([0-9]{1,3}\.){3}[0-9]{1,3}" "$PY_FILE" 2>/dev/null | grep -v "127.0.0.1\|localhost\|0.0.0.0" | grep -v "^#" | head -1; then
              echo "‚ö†Ô∏è  WARNING: Found suspicious IP address in $PY_FILE"
              SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found direct IP address in $PY_FILE - potential data exfiltration risk"
              SECURITY_PASSED=false
            fi
            
            # Check for base64 encoding (often used to obfuscate malicious code)
            if grep -n "import base64\|from base64" "$PY_FILE" 2>/dev/null; then
              if grep -n "decode\|b64decode" "$PY_FILE" 2>/dev/null; then
                echo "‚ö†Ô∏è  INFO: Found base64 decoding in $PY_FILE - review for obfuscated code"
                SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ÑπÔ∏è  Found base64 decoding in $PY_FILE - please review to ensure it's not obfuscating malicious code"
              fi
            fi
            
            # Check for file operations that could be dangerous
            if grep -n "open\s*(" "$PY_FILE" 2>/dev/null | grep -E "w|a|w\+|a\+" | grep -v "^#"; then
              # Check if writing to system directories
              if grep -niE "open\s*\(\s*['\"]/(etc|bin|usr|sys|boot|dev|proc)" "$PY_FILE" 2>/dev/null; then
                echo "‚ö†Ô∏è  WARNING: Found file write to system directory in $PY_FILE"
                SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Found file write to system directory in $PY_FILE - potential system compromise"
                SECURITY_PASSED=false
              fi
            fi
          done
          
          # Run Bandit security scanner
          echo ""
          echo "üîç Running Bandit security scanner..."
          for PY_FILE in $CHANGED_PY_FILES; do
            if [ -f "$PY_FILE" ]; then
              # Run bandit with medium severity threshold
              BANDIT_OUTPUT=$(bandit -l -i -r "$PY_FILE" 2>&1 || true)
              
              # Check for high or medium severity issues
              if echo "$BANDIT_OUTPUT" | grep -E "Severity: (High|Medium)" > /dev/null; then
                echo "‚ö†Ô∏è  Bandit found security issues in $PY_FILE"
                SECURITY_WARNINGS="${SECURITY_WARNINGS}\n- ‚ö†Ô∏è  Bandit security scanner found issues in $PY_FILE"
                SECURITY_PASSED=false
              fi
            fi
          done
          
          echo ""
          if [ "$SECURITY_PASSED" = true ]; then
            echo "‚úÖ Security scan passed - no malicious patterns detected!"
            echo "security_result=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Security scan failed - potentially malicious code detected!"
            echo "security_result=failed" >> $GITHUB_OUTPUT
            echo "security_warnings<<EOF" >> $GITHUB_OUTPUT
            echo -e "$SECURITY_WARNINGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        
      - name: Validate project structure
        id: validate
        run: |
          echo "üîç Validating PR changes..."
          VALIDATION_PASSED=true
          ERRORS=""
          
          # Get list of changed files
          FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          
          # Extract project directories from changed files
          PROJECT_DIRS=$(echo "$FILES" | tr ' ' '\n' | grep -v '^README.md$' | grep -v '^CONTRIBUTING.md$' | grep -v '^LICENSE$' | grep -v '^.github/' | cut -d'/' -f1 | sort -u | grep -v '^$')
          
          if [ -z "$PROJECT_DIRS" ]; then
            echo "‚úÖ Only documentation files changed, skipping project validation"
            echo "validation_result=documentation-only" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üìÅ Projects to validate: $PROJECT_DIRS"
          
          for PROJECT_DIR in $PROJECT_DIRS; do
            echo ""
            echo "Validating: $PROJECT_DIR"
            
            # Check if project directory exists
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå Project directory '$PROJECT_DIR' does not exist"
              ERRORS="${ERRORS}\n- Project directory '$PROJECT_DIR' does not exist"
              VALIDATION_PASSED=false
              continue
            fi
            
            # Check for README.md
            if [ ! -f "$PROJECT_DIR/README.md" ]; then
              echo "‚ùå Missing README.md in $PROJECT_DIR"
              ERRORS="${ERRORS}\n- Missing README.md in $PROJECT_DIR"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ README.md found in $PROJECT_DIR"
              
              # Check if README follows template structure
              REQUIRED_SECTIONS=("Description" "Frameworks and Modules Used" "How to run" "Author")
              for SECTION in "${REQUIRED_SECTIONS[@]}"; do
                if ! grep -qi "$SECTION" "$PROJECT_DIR/README.md"; then
                  echo "‚ö†Ô∏è  README.md in $PROJECT_DIR missing section: $SECTION"
                  ERRORS="${ERRORS}\n- README.md in $PROJECT_DIR should include section: $SECTION"
                  VALIDATION_PASSED=false
                fi
              done
            fi
            
            # Check for at least one Python file
            PY_FILES=$(find "$PROJECT_DIR" -maxdepth 1 -name "*.py" 2>/dev/null | wc -l)
            if [ "$PY_FILES" -eq 0 ]; then
              echo "‚ùå No Python files found in $PROJECT_DIR"
              ERRORS="${ERRORS}\n- No Python files found in $PROJECT_DIR"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Found $PY_FILES Python file(s) in $PROJECT_DIR"
              
              # Validate Python syntax
              for PY_FILE in $PROJECT_DIR/*.py; do
                if [ -f "$PY_FILE" ]; then
                  echo "  Checking syntax: $PY_FILE"
                  if ! python -m py_compile "$PY_FILE" 2>/dev/null; then
                    echo "‚ùå Syntax error in $PY_FILE"
                    ERRORS="${ERRORS}\n- Python syntax error in $PY_FILE"
                    VALIDATION_PASSED=false
                  else
                    echo "  ‚úÖ Syntax valid: $PY_FILE"
                  fi
                fi
              done
            fi
          done
          
          echo ""
          if [ "$VALIDATION_PASSED" = true ]; then
            echo "‚úÖ All validations passed!"
            echo "validation_result=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Validation failed with errors:"
            echo -e "$ERRORS"
            echo "validation_result=failed" >> $GITHUB_OUTPUT
            echo "errors<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Comment on PR - Success
        if: (steps.validate.outputs.validation_result == 'passed' && steps.security-scan.outputs.security_result == 'passed') || (steps.validate.outputs.validation_result == 'passed' && steps.security-scan.outputs.security_result == 'skipped')
        uses: actions/github-script@v7
        with:
          script: |
            const securityStatus = '${{ steps.security-scan.outputs.security_result }}';
            let securityMessage = '';
            if (securityStatus === 'passed') {
              securityMessage = '- ‚úÖ Security scan passed - no malicious code detected\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **PR Validation Passed!**\n\nYour project meets all the requirements:\n- ‚úÖ Project structure is correct\n- ‚úÖ README.md is present and follows the template\n- ‚úÖ Python files have valid syntax\n${securityMessage}\nThis PR is ready for review and can be merged!`
            })
            
      - name: Add auto-merge label
        if: (steps.validate.outputs.validation_result == 'passed' && steps.security-scan.outputs.security_result == 'passed') || (steps.validate.outputs.validation_result == 'passed' && steps.security-scan.outputs.security_result == 'skipped')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['auto-merge-ready']
            })
            
      - name: Comment on PR - Documentation Only
        if: steps.validate.outputs.validation_result == 'documentation-only'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìù **Documentation Update Detected**\n\nThis PR only modifies documentation files (README.md, CONTRIBUTING.md, etc.).\nNo project validation required.\n\nReady for review!'
            })
            
      - name: Comment on PR - Failure
        if: failure() && steps.validate.outputs.validation_result == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const errors = `${{ steps.validate.outputs.errors }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **PR Validation Failed**\n\nPlease fix the following issues:\n${errors}\n\nüìñ Make sure to follow the [Contributing Guidelines](../CONTRIBUTING.md) and use the [README Template](../README_TEMPLATE.md).`
            })
            
      - name: Comment on PR - Security Failure
        if: failure() && steps.security-scan.outputs.security_result == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const warnings = `${{ steps.security-scan.outputs.security_warnings }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üö® **Security Scan Failed - Potentially Malicious Code Detected**\n\n**This PR has been flagged for security concerns:**\n${warnings}\n\n**Action Required:**\n- Review the flagged code patterns\n- Remove any potentially malicious code\n- If these patterns are necessary for your project, please explain their purpose in the PR description\n- A maintainer will review this PR manually\n\n‚ö†Ô∏è  **This PR will NOT be auto-merged due to security concerns.**\n\nüìñ For more information, see our [Contributing Guidelines](../CONTRIBUTING.md).`
            })
